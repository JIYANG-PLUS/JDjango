WITH TTT AS ( SELECT
 to_nchar(t0.FID) AS FID ,t0.FBILLNO -- 单据内码，组装单号
 , t4.FNUMBER AS FMATNUMBER, t5.FNAME AS FMATNAME, t5.FSPECIFICATION -- 物料编码、物料名称、规格型号
 , t0.F_KEL_DECIMAL AS FLOSEQTY -- 损耗数量（差异额）
 , t7.B154043, t7.B154042, t7.B153542
 , t7.B154043 * t0.F_KEL_DECIMAL AS MB154043
 , t7.B154042 * t0.F_KEL_DECIMAL AS MB154042
 , t7.B153542 * t0.F_KEL_DECIMAL AS MB153542
 FROM T_STK_ASSEMBLY t0 -- 组装拆卸单 头
  LEFT JOIN T_BD_MATERIAL t4 ON t0.FPUSHMATERIALID = t4.FMATERIALID  -- 物料
  LEFT JOIN T_BD_MATERIAL_L t5 ON t0.FPUSHMATERIALID = t5.FMATERIALID and t5.FLOCALEID = 2052 -- 物料中文表
  LEFT JOIN KEL_t_Cust100003_LK t6 ON t6.FSID = t0.FID -- 组装拆卸-损耗原因记录表  关联表
  LEFT JOIN (SELECT
         FID
         , SUM(B154043) B154043
         , SUM(B154042) B154042
         , SUM(B153542) B153542
        FROM
         (SELECT
           FID
           , (CASE FLOSEREASON WHEN 154043 THEN PERQTY ELSE 0 END) B154043
           , (CASE FLOSEREASON WHEN 154042 THEN PERQTY ELSE 0 END) B154042
           , (CASE FLOSEREASON WHEN 153542 THEN PERQTY ELSE 0 END) B153542
          FROM
           (SELECT
            s2.FID, s1.FLOSEREASON, s1.FQTY / s2.F_KEL_DECIMAL AS PERQTY -- 损耗原因，损耗百分比
            FROM KEL_t_Cust_Entry100002 s1 -- 损耗原因记录表 体
             LEFT JOIN KEL_t_Cust100003 s2 ON s1.FID = s2.FID -- 损耗原因 头
           )
         )
         GROUP BY FID
        ) t7 ON t6.FID = t7.FID
 WHERE
  t0.F_KEL_CHECKBOX = 1 -- 已下推的组装拆卸单
) 

SELECT FBILLNO, FMATNUMBER, FMATNAME, FSPECIFICATION, FLOSEQTY, B154043, B154042, B153542 FROM TTT
UNION
SELECT to_nchar('合计'), to_nchar(' '), to_nchar(' '), to_nchar(' '), SUM(FLOSEQTY), SUM(MB154043), SUM(MB154042), SUM(MB153542) FROM TTT